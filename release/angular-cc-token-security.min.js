"use strict";var security=angular.module("ccTokenSecurity",["ccTokenSecurity.events","ccTokenSecurity.storage","ccTokenSecurity.interceptor","ccTokenSecurity.service","ccTokenSecurity.provider","ngResource","ui.router"]);security.run(["$state","$rootScope","$location","AUTH_EVENTS","Session","Auth","ccTokenSecurity",function(a,b,c,d,e,f,g){var h=g.getLogin(),i=g.getAccessForbidden();delete b.originalPath,b.$on("$stateChangeStart",function(d,e){var g=e.access;f.permitAll(g)||(f.isNotAuthenticated()?(d.preventDefault(),b.originalPath=c.path(),a.go(h.state)):f.hasRole(g)||(d.preventDefault(),a.go(i.state)))}),b.$on(d.notAuthenticated,function(){a.go(h.state)}),b.$on(d.notAuthorized,function(){a.go(i.state)})}]),angular.module("ccTokenSecurity.events",[]).constant("AUTH_EVENTS",{notAuthenticated:"notAuthenticated",notAuthorized:"notAuthorized"}),angular.module("ccTokenSecurity.service",["ccTokenSecurity.storage"]).factory("Auth",["Session",function(a){var b={};return b.permitAll=function(a){return!angular.isDefined(a)},b.isAuthenticated=function(){return null!==a.user()},b.isNotAuthenticated=function(){return!b.isAuthenticated()},b.hasRole=function(b){var c=a.user();if(null===c)return!1;var d=!1;return angular.forEach(c.roles,function(a){b===a&&(d=!0)}),d},b.currentUser=function(){return a.user()},b}]),angular.module("ccTokenSecurity.interceptor",["ccTokenSecurity.events","ccTokenSecurity.storage","ccTokenSecurity.provider"]).factory("securityInterceptor",["$rootScope","$q","Session","AUTH_EVENTS","ccTokenSecurity",function(a,b,c,d,e){var f={request:function(a){var b=c.authToken(),d=e.getTokenKey();return b&&(a.headers[d]=b),a},responseError:function(c){var e=c.status;return 401==e?a.$broadcast(d.notAuthenticated,c):403==e&&a.$broadcast(d.notAuthorized,c),b.reject(c)}};return f}]).config(["$httpProvider",function(a){a.interceptors.push("securityInterceptor")}]),angular.module("ccTokenSecurity.storage",["LocalStorageModule","ccTokenSecurity.provider"]).factory("Session",["localStorageService","ccTokenSecurity",function(a,b){var c=b.getTokenKey(),d=b.getUserKey();return{create:function(b){a.set(c,b.token),a.set(d,b)},user:function(){return a.get(d)},authToken:function(){return a.get(c)},invalidate:function(){a.remove(c),a.remove(d)}}}]),angular.module("ccTokenSecurity.provider",["ui.router"]).provider("ccTokenSecurity",function(a){function b(b,c){angular.extend(b,c),a.state(b.state,b)}var c="x-auth-token",d="user",e={state:"login",url:"/login",templateUrl:"views/login.html",nextState:"main",originalPath:!0},f={state:"logout",url:"/logout",controller:"LogoutController",nextState:"login"},g={state:"accessForbidden",url:"/accessForbidden"};this.setTokenKey=function(a){c=a},this.setUserKey=function(a){d=a},this.login=function(a){b(e,a)},this.logout=function(a){b(f,a)},this.accessForbidden=function(a){b(g,a)},this.$get=function(){return{getTokenKey:function(){return c},getUserKey:function(){return d},getLogin:function(){return e},getLogout:function(){return f},getAccessForbidden:function(){return g}}}}),angular.module("ccTokenSecurity").controller("LoginController",["$http","$scope","$rootScope","$location","$state","$stateParams","AuthResource","Session","ccTokenSecurity",function(a,b,c,d,e,f,g,h,i){function j(){k.originalPath&&c.originalPath?(d.path(c.originalPath),delete c.originalPath):e.go(k.nextState)}var k=i.getLogin();b.login=function(a,c){g.authenticate("username="+a+"&password="+c).$promise.then(function(a){b.$parent.currentUser=a,h.create(a),j()})["catch"](function(){b.authenticationError=!0,b.tokenExpired=!1,h.invalidate()})},b.tokenExpired=null!==h.user()}]).factory("AuthResource",["$resource",function(a){return a(":action",{},{authenticate:{method:"POST",params:{action:"authenticate"},headers:{"Content-Type":"application/x-www-form-urlencoded"}}})}]),angular.module("ccTokenSecurity").controller("LogoutController",["$state","Session","ccTokenSecurity",function(a,b,c){var d=c.getLogout();b.invalidate(),a.go(d.nextState)}]);