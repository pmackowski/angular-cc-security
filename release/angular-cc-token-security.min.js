"use strict";var security=angular.module("ccTokenSecurity",["ccTokenSecurity.events","ccTokenSecurity.storage","ccTokenSecurity.interceptor","ccTokenSecurity.service","ccTokenSecurity.provider","ngResource","ui.router"]);security.run(["$state","$rootScope","$location","AUTH_EVENTS","Auth","ccTokenSecurity",function(a,b,c,d,e,f){var g=f.getLogin(),h=f.getAccessForbidden();delete b.originalPath,b.$on("$stateChangeStart",function(d,f){var i=f.access;e.permitAll(i)||(e.isNotAuthenticated()?(d.preventDefault(),b.originalPath=c.path(),a.go(g.state)):e.hasRole(i)||(d.preventDefault(),a.go(h.state)))}),b.$on(d.notAuthenticated,function(){a.go(g.state)}),b.$on(d.notAuthorized,function(){a.go(h.state)})}]),angular.module("ccTokenSecurity.events",[]).constant("AUTH_EVENTS",{notAuthenticated:"notAuthenticated",notAuthorized:"notAuthorized"}),angular.module("ccTokenSecurity.service",["ccTokenSecurity.storage","ccTokenSecurity.provider","ngResource","ui.router"]).factory("Auth",["Session","ccTokenSecurity","$state","$rootScope","$location",function(a,b,c,d,e){var f={};return f.permitAll=function(a){return!angular.isDefined(a)},f.isAuthenticated=function(){return null!==a.user()},f.isNotAuthenticated=function(){return!f.isAuthenticated()},f.hasRole=function(b){var c=a.user();if(null===c)return!1;var d=!1;return angular.forEach(c.roles,function(a){b===a&&(d=!0)}),d},f.currentUser=function(){return a.user()},f.login=function(f){a.create(f);var g=b.getLogin();g.originalPath&&d.originalPath?(e.path(d.originalPath),delete d.originalPath):c.go(g.nextState)},f.logout=function(){var d=b.getLogout();a.invalidate(),c.go(d.nextState)},f.invalidateSession=function(){a.invalidate()},f}]),angular.module("ccTokenSecurity.interceptor",["ccTokenSecurity.events","ccTokenSecurity.storage","ccTokenSecurity.provider"]).factory("securityInterceptor",["$rootScope","$q","Session","AUTH_EVENTS","ccTokenSecurity",function(a,b,c,d,e){var f={request:function(a){var b=c.authToken(),d=e.getTokenKey();return b&&(a.headers[d]=b),a},responseError:function(c){var e=c.status;return 401==e?a.$broadcast(d.notAuthenticated,c):403==e&&a.$broadcast(d.notAuthorized,c),b.reject(c)}};return f}]).config(["$httpProvider",function(a){a.interceptors.push("securityInterceptor")}]),angular.module("ccTokenSecurity.storage",["LocalStorageModule","ccTokenSecurity.provider"]).factory("Session",["localStorageService","ccTokenSecurity",function(a,b){var c=b.getTokenKey(),d=b.getUserKey();return{create:function(b){a.set(c,b.token),a.set(d,b)},user:function(){return a.get(d)},authToken:function(){return a.get(c)},invalidate:function(){a.remove(c),a.remove(d)}}}]),angular.module("ccTokenSecurity.provider",["ui.router"]).provider("ccTokenSecurity",function(a){function b(b,c){angular.extend(b,c),a.state(b.state,b)}var c="x-auth-token",d="user",e={state:"login",url:"/login",templateUrl:"views/login.html",controller:"LoginController",nextState:"main",originalPath:!0,authenticateUrl:"authenticate?username={{ username }}&password={{ password }}",onInit:function(){},onLoginSuccess:function(){},onLoginError:function(){}},f={state:"logout",url:"/logout",controller:"LogoutController",nextState:"login"},g={state:"accessForbidden",url:"/accessForbidden"};this.setTokenKey=function(a){c=a},this.setUserKey=function(a){d=a},this.login=function(a){b(e,a)},this.logout=function(a){b(f,a)},this.accessForbidden=function(a){b(g,a)},this.$get=function(){return{getTokenKey:function(){return c},getUserKey:function(){return d},getLogin:function(){return e},getLogout:function(){return f},getAccessForbidden:function(){return g}}}}),angular.module("ccTokenSecurity").controller("LoginController",["$http","$scope","Auth","ccTokenSecurity",function(a,b,c,d){var e=d.getLogin();e.onInit(b,c),b.login=function(d,f){var g=/{{\s*username\s*}}/,h=/{{\s*password\s*}}/,i=e.authenticateUrl.replace(g,d).replace(h,f);a.post(i).success(function(a){c.login(a),e.onLoginSuccess(b,a)}).error(function(){c.invalidateSession(),e.onLoginError(b)})}}]),angular.module("ccTokenSecurity").controller("LogoutController",["Auth",function(a){a.logout()}]);